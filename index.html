<!-- ESTILOS (CSS) -->
<style>
    .chat-wrapper {
        font-family: 'Segoe UI', Helvetica, Arial, sans-serif;
        max-width: 450px;
        margin: 0 auto;
        background: #efe7dd; /* Fondo WhatsApp cl√°sico */
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 10px 30px rgba(0,0,0,0.25);
        display: flex;
        flex-direction: column;
        height: 650px; /* Un poco m√°s alto para ver mejor */
        position: relative;
        border: 1px solid #ccc;
    }

    /* Header */
    .chat-header {
        background: #008069;
        color: white;
        padding: 10px 15px;
        display: flex;
        align-items: center;
        gap: 10px;
        z-index: 10;
        box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
    .avatar {
        width: 42px;
        height: 42px;
        background: url('https://ui-avatars.com/api/?name=Alex&background=fff&color=008069&bold=true');
        background-size: cover;
        border-radius: 50%;
    }
    .user-info div:first-child { font-weight: 600; font-size: 16px; }
    .status { font-size: 12px; opacity: 0.85; }

    /* Cuerpo del chat */
    .chat-body {
        flex: 1;
        padding: 15px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 8px;
        background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png');
        background-opacity: 0.5;
    }

    /* Burbujas */
    .bubble {
        max-width: 75%;
        padding: 8px 12px;
        border-radius: 7px;
        font-size: 14.5px;
        line-height: 1.35;
        position: relative;
        box-shadow: 0 1px 1px rgba(0,0,0,0.1);
        animation: slideIn 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94) both;
    }
    .incoming { background: white; align-self: flex-start; border-top-left-radius: 0; }
    .outgoing { background: #d9fdd3; align-self: flex-end; border-top-right-radius: 0; }
    
    .system-msg {
        background: #e1f5fe;
        color: #0277bd;
        font-size: 12px;
        text-align: center;
        padding: 5px 10px;
        border-radius: 10px;
        align-self: center;
        margin: 10px 0;
        border: 1px solid #b3e5fc;
        font-weight: bold;
    }

    /* Indicador escribiendo */
    .typing {
        background: white;
        padding: 8px 12px;
        border-radius: 15px;
        align-self: flex-start;
        display: none;
        gap: 4px;
        margin-bottom: 5px;
        width: fit-content;
    }
    .dot {
        width: 6px;
        height: 6px;
        background: #999;
        border-radius: 50%;
        animation: pulse 1s infinite;
    }
    .dot:nth-child(2) { animation-delay: 0.2s; }
    .dot:nth-child(3) { animation-delay: 0.4s; }

    /* √Årea inferior (Opciones y Medidor) */
    .bottom-area {
        background: #f0f2f5;
        border-top: 1px solid #ddd;
        padding: 0;
    }

    /* VIOLENT√ìMETRO BARRA */
    .meter-wrapper {
        padding: 10px 15px 5px 15px;
        background: #fff;
    }
    .meter-label {
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 1px;
        font-weight: bold;
        margin-bottom: 5px;
        color: #555;
        display: flex;
        justify-content: space-between;
    }
    .meter-track {
        height: 10px;
        background: #eee;
        border-radius: 5px;
        overflow: hidden;
        position: relative;
    }
    .meter-fill {
        height: 100%;
        width: 0%; /* Empieza vac√≠o */
        transition: width 0.6s ease, background 0.6s ease;
    }
    /* Zonas del violent√≥metro */
    .z-yellow { background: #fbc02d; } /* Cuidado */
    .z-orange { background: #f57c00; } /* Reacciona */
    .z-red { background: #d32f2f; }    /* Ayuda */

    /* Botones */
    .options-grid {
        display: flex;
        flex-direction: column;
        gap: 8px;
        padding: 10px 15px 15px 15px;
    }
    .opt-btn {
        background: white;
        border: 1px solid #ccc;
        color: #333;
        padding: 12px;
        border-radius: 8px;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s;
        text-align: left;
    }
    .opt-btn:hover {
        background: #f5f5f5;
        border-color: #008069;
        color: #008069;
        font-weight: 600;
    }

    /* Efecto temblor para violencia alta */
    .shake-hard { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }

    @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes pulse { 0%, 100% { opacity: 0.4; transform: scale(0.8); } 50% { opacity: 1; transform: scale(1.1); } }
    @keyframes shake { 10%, 90% { transform: translate3d(-2px, 0, 0); } 20%, 80% { transform: translate3d(3px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-5px, 0, 0); } 40%, 60% { transform: translate3d(5px, 0, 0); } }

</style>

<div class="chat-wrapper" id="v-app">
    <!-- Encabezado -->
    <div class="chat-header">
        <div class="avatar"></div>
        <div class="user-info">
            <div>Alex (Amor ‚ù§Ô∏è)</div>
            <div class="status" id="v-status">En l√≠nea</div>
        </div>
    </div>

    <!-- Chat -->
    <div class="chat-body" id="v-chat">
        <div class="system-msg">Hoy</div>
        <!-- Mensajes van aqu√≠ -->
        <div class="typing" id="v-typing">
            <div class="dot"></div><div class="dot"></div><div class="dot"></div>
        </div>
    </div>

    <!-- Zona Inferior -->
    <div class="bottom-area">
        <!-- Violent√≥metro Visual -->
        <div class="meter-wrapper">
            <div class="meter-label">
                <span>Violent√≥metro:</span>
                <span id="v-meter-text" style="color:#999;">Normal</span>
            </div>
            <div class="meter-track">
                <div class="meter-fill" id="v-bar"></div>
            </div>
        </div>

        <!-- Opciones -->
        <div class="options-grid" id="v-options">
            <button class="opt-btn" onclick="iniciarSimulacion()">üì≤ Abrir chat</button>
        </div>
    </div>
</div>

<!-- L√ìGICA DE JUEGO (VIOLENCIA DE G√âNERO) -->
<script>
    /* 
       CONFIGURACI√ìN DE LA HISTORIA 
       La narrativa sigue las fases del Violent√≥metro:
       0-10: Normal
       11-40: Amarillo (Cuidado: Celos, control, bromas hirientes)
       41-70: Naranja (Reacciona: Humillaci√≥n, prohibiciones, destruir art√≠culos)
       71-100: Rojo (Ayuda: Amenazas, agresi√≥n)
    */

    const guion = {
        'inicio': {
            msgs: [
                "Hola beb√©. ¬øYa llegaste a casa?",
                "Vi en tu historia que saliste con ese vestido rojo..."
            ],
            opts: [
                { txt: "S√≠, ya llegu√©. ¬øTe gusta el vestido?", irA: 'fase_amarilla_a', valor: 15 },
                { txt: "¬øPasa algo con mi vestido?", irA: 'fase_amarilla_b', valor: 25 }
            ]
        },
        'fase_amarilla_a': {
            msgs: [
                "Mmm, s√≠. Pero se te ve mucha pierna.",
                "Sabes que no me gusta que otros hombres te miren as√≠. Lo digo por cuidarte."
            ],
            sys: "‚ö†Ô∏è VIOLENT√ìMETRO: Celos y Control (Zona Amarilla)",
            opts: [
                { txt: "Ay amor, no exageres. Solo es ropa.", irA: 'fase_naranja', valor: 35 },
                { txt: "Perd√≥n, la pr√≥xima me pongo otra cosa.", irA: 'sumision_naranja', valor: 45 }
            ]
        },
        'fase_amarilla_b': {
            msgs: [
                "Uy, qu√© defensiva. Solo dec√≠a.",
                "√öltimamente est√°s muy rara, seguro tus amigas te meten cosas en la cabeza."
            ],
            sys: "‚ö†Ô∏è VIOLENT√ìMETRO: Descalificar opiniones (Zona Amarilla)",
            opts: [
                { txt: "Mis amigas no tienen nada que ver.", irA: 'fase_naranja', valor: 40 },
                { txt: "(Dejar en visto)", irA: 'fase_roja_amenaza', valor: 60 }
            ]
        },
        'fase_naranja': {
            msgs: [
                "¬øVes? Siempre me llevas la contraria. Est√°s loca.",
                "P√°same tu contrase√±a de Instagram. Quiero ver con qui√©n hablas tanto."
            ],
            sys: "‚ö†Ô∏è ALERTA: Control de redes y humillaci√≥n (Zona Naranja)",
            opts: [
                { txt: "No, mi contrase√±a es privada.", irA: 'fase_roja_amenaza', valor: 75 },
                { txt: "Est√° bien, toma, pero no te enojes.", irA: 'final_ciclo', valor: 80 }
            ]
        },
        'sumision_naranja': {
            msgs: [
                "M√°s te vale. Eres m√≠a, acu√©rdate.",
                "Si te quisiera otro, no te aguantar√≠a tus berrinches como yo."
            ],
            sys: "‚ö†Ô∏è ALERTA: Destrucci√≥n de autoestima (Zona Naranja)",
            opts: [
                { txt: "Gracias por quererme as√≠...", irA: 'final_ciclo', valor: 65 },
                { txt: "Eso me doli√≥.", irA: 'fase_naranja', valor: 50 }
            ]
        },
        'fase_roja_amenaza': {
            msgs: [
                "Ah, ¬øahora te crees muy lista?",
                "Voy para tu casa. Y m√°s te vale que me abras o tiro la puerta.",
                "No me obligues a hacer algo de lo que te arrepientas."
            ],
            sys: "üÜò PELIGRO: Amenazas e Intimidaci√≥n (Zona Roja)",
            opts: [
                { txt: "BLOQUEAR Y PEDIR AYUDA", irA: 'final_ayuda', valor: 100 }
            ]
        },
        'final_ciclo': {
            msgs: [
                "Bueno, descansa. Y borra esa foto.",
                "Te amo, loquita. ‚ù§Ô∏è"
            ],
            sys: "üî¥ DIAGN√ìSTICO: Est√°s en el Ciclo de la Violencia. Hoy pidi√≥ la clave, ma√±ana puede ser un golpe. ¬°Busca ayuda!",
            opts: [
                { txt: "Reiniciar Simulador", irA: 'inicio', valor: 0 }
            ]
        },
        'final_ayuda': {
            msgs: [
                "üö´ CONTACTO BLOQUEADO",
                "Has tomado la decisi√≥n correcta.",
                "Si esto te suena familiar, no est√°s sola. Llama a la l√≠nea de ayuda."
            ],
            sys: "üèÜ Has roto el ciclo de violencia.",
            opts: [
                { txt: "Reiniciar Simulador", irA: 'inicio', valor: 0 }
            ]
        }
    };

    // --- MOTOR DEL JUEGO ---
    const chat = document.getElementById('v-chat');
    const optionsDiv = document.getElementById('v-options');
    const typing = document.getElementById('v-typing');
    const status = document.getElementById('v-status');
    const bar = document.getElementById('v-bar');
    const barText = document.getElementById('v-meter-text');
    const appWindow = document.getElementById('v-app');

    function iniciarSimulacion() {
        chat.innerHTML = '<div class="system-msg">Hoy</div>';
        chat.appendChild(typing);
        renderNodo('inicio');
    }

    function renderNodo(id) {
        optionsDiv.innerHTML = ''; // Limpiar botones
        const data = guion[id];
        let delayAcumulado = 0;

        // Resetear barra si volvemos al inicio
        if (id === 'inicio') actualizarViolentometro(0);

        data.msgs.forEach((msg, i) => {
            // Calcular tiempo realista de escritura
            const tiempoLectura = 1000 + (msg.length * 25);
            
            setTimeout(() => {
                mostrarEscribiendo();
            }, delayAcumulado);

            delayAcumulado += tiempoLectura;

            setTimeout(() => {
                ocultarEscribiendo();
                crearBurbuja(msg, 'incoming');
                
                // Si hay mensaje de sistema (diagn√≥stico) en este paso y es el √∫ltimo msg
                if (i === data.msgs.length - 1) {
                    if(data.sys) crearMsjSistema(data.sys);
                    mostrarOpciones(data.opts);
                    // Usamos el valor de la primera opci√≥n como referencia para actualizar la barra YA
                    // o podr√≠as actualizarla al hacer click. Aqu√≠ lo hago visual al recibir el ataque.
                    if (data.opts[0].valor > 0) actualizarViolentometro(data.opts[0].valor);
                }
            }, delayAcumulado);
        });
    }

    function crearBurbuja(texto, tipo) {
        const div = document.createElement('div');
        div.className = `bubble ${tipo}`;
        div.innerText = texto;
        chat.insertBefore(div, typing);
        chat.scrollTop = chat.scrollHeight;

        // Vibrar si es mensaje entrante (simula impacto emocional)
        if(tipo === 'incoming') {
            appWindow.classList.add('shake-hard');
            setTimeout(()=> appWindow.classList.remove('shake-hard'), 500);
        }
    }

    function crearMsjSistema(texto) {
        const div = document.createElement('div');
        div.className = 'system-msg';
        div.innerText = texto;
        chat.insertBefore(div, typing);
        chat.scrollTop = chat.scrollHeight;
    }

    function mostrarEscribiendo() {
        typing.style.display = 'flex';
        status.innerText = 'Escribiendo...';
        chat.scrollTop = chat.scrollHeight;
    }

    function ocultarEscribiendo() {
        typing.style.display = 'none';
        status.innerText = 'En l√≠nea';
    }

    function mostrarOpciones(listaOpts) {
        listaOpts.forEach(opt => {
            const btn = document.createElement('button');
            btn.className = 'opt-btn';
            btn.innerText = opt.txt;
            btn.onclick = () => {
                crearBurbuja(opt.txt, 'outgoing');
                // Forzar actualizaci√≥n de barra basada en la decisi√≥n tomada (importante si hay caminos diferentes)
                actualizarViolentometro(opt.valor);
                renderNodo(opt.irA);
            };
            optionsDiv.appendChild(btn);
        });
    }

    function actualizarViolentometro(nivel) {
        bar.style.width = nivel + '%';
        bar.className = 'meter-fill'; // Reset clases

        let texto = "Normal";
        let colorClass = "";

        if (nivel > 10 && nivel <= 40) {
            texto = "‚ö†Ô∏è AMARILLO: Ten Cuidado";
            colorClass = "z-yellow";
            barText.style.color = "#fbc02d";
        } else if (nivel > 40 && nivel <= 70) {
            texto = "‚úã NARANJA: Reacciona";
            colorClass = "z-orange";
            barText.style.color = "#f57c00";
        } else if (nivel > 70) {
            texto = "üÜò ROJO: ¬°Busca Ayuda!";
            colorClass = "z-red";
            barText.style.color = "#d32f2f";
        } else {
            barText.style.color = "#999";
        }

        if(colorClass) bar.classList.add(colorClass);
        barText.innerText = texto;
    }
</script>